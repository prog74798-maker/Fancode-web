<?php
session_start();
if (!isset($_SESSION['user'])) {
    header("Location: /api/login.php");
    exit();
}

// Vercel-specific directory setup
$directories = [
    "data" => "/tmp/data",
    "filter" => "/tmp/data/filter", 
    "playlist" => "/tmp/data/playlist"
];

foreach ($directories as $dir_path) {
    if (!is_dir($dir_path)) {
        mkdir($dir_path, 0777, true);
    }
}

$tokenFile = $directories["data"] . "/token.txt";
$jsonFile = $directories["data"] . "/data.json";

date_default_timezone_set("UTC");

// Initialize variables
$url = $mac = $sn = $device_id_1 = $device_id_2 = $sig = "";
$message = $message_type = "";

if (file_exists($jsonFile)) {
    $jsonData = file_get_contents($jsonFile);
    $data = json_decode($jsonData, true);
    if ($data !== null) {
        $url = $data["url"] ?? "";
        $mac = $data["mac"] ?? "";
        $sn = $data["serial_number"] ?? "";
        $device_id_1 = $data["device_id_1"] ?? "";
        $device_id_2 = $data["device_id_2"] ?? "";
        $sig = $data["signature"] ?? "";
    }
}

// Handle form submission
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $url = filter_input(INPUT_POST, 'url', FILTER_SANITIZE_URL);
    $mac = filter_input(INPUT_POST, 'mac', FILTER_SANITIZE_STRING);
    $sn = filter_input(INPUT_POST, 'sn', FILTER_SANITIZE_STRING);
    $device_id_1 = filter_input(INPUT_POST, 'device_id_1', FILTER_SANITIZE_STRING);
    $device_id_2 = filter_input(INPUT_POST, 'device_id_2', FILTER_SANITIZE_STRING);
    $sig = filter_input(INPUT_POST, 'sig', FILTER_SANITIZE_STRING);
    
    if (empty($url) || empty($mac)) {
        $message = "URL and MAC address are required!";
        $message_type = "error";
    } else {
        $configData = [
            "url" => $url,
            "mac" => $mac,
            "serial_number" => $sn,
            "device_id_1" => $device_id_1,
            "device_id_2" => $device_id_2,
            "signature" => $sig
        ];
        
        if (file_put_contents($jsonFile, json_encode($configData, JSON_PRETTY_PRINT))) {
            $message = "Configuration saved successfully!";
            $message_type = "success";
        } else {
            $message = "Error saving configuration!";
            $message_type = "error";
        }
    }
}

// Test connection
if (isset($_GET['test'])) {
    require_once 'config.php';
    $token = generate_token();
    if (!empty($token)) {
        $message = "Connection successful! Token generated.";
        $message_type = "success";
    } else {
        $message = "Connection failed! Please check your configuration.";
        $message_type = "error";
    }
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration - mac2m3u</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            min-height: 100vh;
            margin: 0;
            color: #e0e0e0;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(34, 40, 49, 0.9);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        h1 {
            color: #00d4ff;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            color: #a0a0a0;
            margin-bottom: 5px;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: #e0e0e0;
            font-size: 16px;
            box-sizing: border-box;
        }
        .form-group input:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 5px rgba(0, 212, 255, 0.5);
        }
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(45deg, #0077b6, #023e8a);
            color: white;
        }
        .btn-primary:hover {
            background: linear-gradient(45deg, #0096c7, #0353a4);
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
            color: white;
        }
        .btn-secondary:hover {
            background: linear-gradient(45deg, #868e96, #5a6268);
            transform: translateY(-2px);
        }
        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }
        .success {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid #28a745;
            color: #28a745;
        }
        .error {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            color: #dc3545;
        }
        .nav {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        .nav a {
            color: #00d4ff;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 10px;
            background: rgba(0, 212, 255, 0.1);
            transition: all 0.3s ease;
        }
        .nav a:hover {
            background: rgba(0, 212, 255, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav">
            <a href="/api/index.php">Home</a>
            <a href="/api/logout.php">Logout</a>
        </div>
        
        <h1>Portal Configuration</h1>
        
        <?php if (!empty($message)): ?>
            <div class="message <?php echo $message_type; ?>">
                <?php echo htmlspecialchars($message); ?>
            </div>
        <?php endif; ?>
        
        <form method="POST" action="">
            <div class="form-group">
                <label for="url">Portal URL</label>
                <input type="url" id="url" name="url" value="<?php echo htmlspecialchars($url); ?>" placeholder="http://portal.example.com" required>
            </div>
            
            <div class="form-group">
                <label for="mac">MAC Address</label>
                <input type="text" id="mac" name="mac" value="<?php echo htmlspecialchars($mac); ?>" placeholder="00:1A:79:XX:XX:XX" required>
            </div>
            
            <div class="form-group">
                <label for="sn">Serial Number (Optional)</label>
                <input type="text" id="sn" name="sn" value="<?php echo htmlspecialchars($sn); ?>" placeholder="Serial number">
            </div>
            
            <div class="form-group">
                <label for="device_id_1">Device ID 1 (Optional)</label>
                <input type="text" id="device_id_1" name="device_id_1" value="<?php echo htmlspecialchars($device_id_1); ?>" placeholder="Device ID 1">
            </div>
            
            <div class="form-group">
                <label for="device_id_2">Device ID 2 (Optional)</label>
                <input type="text" id="device_id_2" name="device_id_2" value="<?php echo htmlspecialchars($device_id_2); ?>" placeholder="Device ID 2">
            </div>
            
            <div class="form-group">
                <label for="sig">Signature (Optional)</label>
                <input type="text" id="sig" name="sig" value="<?php echo htmlspecialchars($sig); ?>" placeholder="Signature">
            </div>
            
            <div class="button-group">
                <button type="submit" name="save_config" class="btn-primary">Save Configuration</button>
                <a href="?test=1" class="btn-secondary" style="text-decoration: none; text-align: center;">Test Connection</a>
            </div>
        </form>
    </div>
</body>
</html>
